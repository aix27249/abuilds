# ABUILD generated by mkpkg_generator.sh

pkgname=subversion
pkgver=1.8.0
pkgbuild=1
arch=('auto')

shortdesc=('A version control system')
longdesc=('Subversion is a version control system which allows you to keep old versions of files and directories (usually source code), and keep a log of who, when, and why changes occurred, similar to other such systems like CVS, RCS or SCCS. Subversion keeps all the information to permit extracting previous versions of those files at any time. For more information about the Subversion project, visit: http://subversion.tigris.org')

tags=('dev-util develop')

source=("http://www.sai.msu.su/apache/subversion/subversion-${pkgver}.tar.bz2")
build_deps="swig db autoconf apr perl python serf"
docs="BUGS CHANGES COMMITTERS COPYING* HACKING INSTALL README TRANSLATING doc/"

before_build() {
	go_src_dir
	./autogen.sh
}

BUILD_SYSTEM='autotools'
BUILD_KEYS="--prefix=/usr \
  --libdir=/usr/lib${LIBDIRSUFFIX} \
  --mandir=/usr/man \
  --docdir=/usr/doc/subversion-${pkgver} \
  --enable-shared \
  --disable-static \
  --with-apr=/usr/bin/apr-1-config \
  --with-apr-util=/usr/bin/apu-1-config \
  --with-apxs=/usr/sbin/apxs \
  --with-zlib \
  --with-pic \
  --build=$ARCH-slackware-linux"

INSTALL_KEYS="DESTDIR=$pkgdir"

after_build() {
	go_src_dir
	make install-docs DESTDIR=$pkgdir || exit 1

	# Install python bindings
	make swig-py
	make install-swig-py DESTDIR=$pkgdir
	PYTHON_VER=$(python -c 'import sys; print "%d.%d" % sys.version_info[:2]')
	mkdir -p $pkgdir/usr/lib${LIBDIRSUFFIX}/python${PYTHON_VER}/site-packages
	mv $pkgdir/usr/lib${LIBDIRSUFFIX}/svn-python/* \
	$pkgdir/usr/lib${LIBDIRSUFFIX}/python${PYTHON_VER}/site-packages
	rmdir $pkgdir/usr/lib${LIBDIRSUFFIX}/svn-python
	
	# Perl bindings
	make -j${numjobs} swig-pl-lib
	make install-swig-pl-lib DESTDIR=$pkgdir
	( cd subversion/bindings/swig/perl/native
	perl Makefile.PL
	make install_vendor DESTDIR=$pkgdir
	)
	eval $(perl '-V:archlib')
	mv $pkgdir/$archlib/perllocal.pod $pkgdir/$archlib/subversion.pod
	
	# Ruby bindings
	#make swig-rb
	#make install-swig-rb DESTDIR=$pkgdir
	
	rm -rf $pkgdir/usr/info
	# Something doesn't honor --mandir
	#mv $pkgdir/usr/share/man/man3 $pkgdir/usr/man
	#gzip -9 $pkgdir/usr/man/man?/*
	#rmdir $pkgdir/usr/share/man
	
	# What is this junk for?  Since I don't know, I'll erase it.  :-)
	rm -rf $pkgdir/usr/build
	
	# too big && useless for most || if you think not, can be found in the source tarball
	rm -rf $pkgdir/usr/doc/subversion-$pkgver/doc/tools
	
	# This removes our DESTDIR from the packlist filenames, to keep perl's
	# internal inventories consistent and correct.
	find $pkgdir -name .packlist | while read plist ; do
	sed -e "s%/share/man%/man%g" \
	-e "s%$pkgdir%%g" \
	-e "s%\.1$%\.1\.gz%g" \
	-e "s%\.2$%\.2\.gz%g" \
	-e "s%\.3$%\.3\.gz%g" \
	-e "s%\.3pm$%\.3pm\.gz%g" \
	-e "s%\.4$%\.4\.gz%g" \
	-e "s%\.5$%\.5\.gz%g" \
	-e "s%\.6$%\.6\.gz%g" \
	-e "s%\.7$%\.7\.gz%g" \
	-e "s%\.8$%\.8\.gz%g" \
	${plist} > ${plist}.new
	  mv -f ${plist}.new ${plist}
	done

	# OpenRC scripts for svnserve
	install -Dm755 ${filedir}/svnserve.initd ${pkgdir}/etc/init.d/svnserve
	install -Dm644 ${filedir}/svnserve.confd ${pkgdir}/etc/conf.d/svnserve.new
}

