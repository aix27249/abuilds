# ABUILD generated by mkpkg_generator.sh

pkgname=openldap
pkgver=2.4.35
pkgbuild=2
arch=("auto")

shortdesc=("openldap (OpenLDAP client and server programs)")
longdesc=("OpenLDAP is an open source implementation of the Lightweight Directory Access Protocol. LDAP is a alternative to the X.500 Directory Access Protocol (DAP). It uses the TCP/IP stack versus the overly complex OSI stack. LDAP is often used to provide authentication (such as for email). The OpenLDAP homepage is http://www.openldap.org/")

tags=("network net-misc")

source=("http://www.openldap.org/software/download/OpenLDAP/openldap-release/openldap-${pkgver}.tgz")
config_files="etc/openldap/ldap.conf
etc/openldap/slapd.conf
etc/conf.d/slapd"

build_deps="libtool cyrus-sasl e2fsprogs util-linux-ng tcp_wrappers"

before_build() {
	go_src_dir
	sed -i 's|-m 644 $(LIBRARY)|-m 755 $(LIBRARY)|' libraries/{liblber,libldap,libldap_r}/Makefile.in
}

BUILD_SYSTEM="autotools"

BUILD_KEYS="--prefix=/usr \
  	--libdir=/usr/lib${LIBDIRSUFFIX} \
	--localstatedir=/var/lib \
	--sysconfdir=/etc \
	--mandir=/usr/man \
	--with-cyrus-sasl \
	--with-tls \
	--with-threads \
	--enable-debug \
	--enable-syslog \
	--enable-dynamic \
	--enable-local \
	--enable-proctitle \
  	--enable-cleartext \
	--enable-crypt \
	--enable-lmpasswd \
	--enable-spasswd \
	--enable-modules \
  	--enable-perl \
  	--enable-shell \
  	--enable-ldap \
	--enable-slapd \
	--enable-dynacl \
	--enable-aci \
	--enable-rewrite \
	--enable-rlookups \
	--enable-slapi \
	--enable-wrappers \
	--enable-ndb=no"

INSTALL_KEYS="DESTDIR=$pkgdir"

after_build() {
	rm -f ${pkgdir}/etc/openldap/slapd.conf.default
	rm -f ${pkgdir}/etc/openldap/ldap.conf.default
	cat << EOF >> ${pkgdir}/etc/openldap/ldap.conf

# In order to avoid problems with self-signed certificates using TLS:
# "TLS certificate verification: Error, self signed certificate"
# See also 'man ldap.conf' or http://www.openldap.org/doc/admin/tls.html
TLS_REQCERT allow

EOF

	install -Dm0755 ${filedir}/slapd-initd ${pkgdir}/etc/init.d/slapd
	install -Dm0644 ${filedir}/slapd-confd ${pkgdir}/etc/conf.d/slapd
}
