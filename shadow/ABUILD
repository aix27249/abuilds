# ABUILD generated by mkpkg_generator.sh

pkgname=shadow
pkgver=4.1.5.1
pkgbuild=1
arch=("auto")

shortdesc=("shadow password suite")
longdesc=("This set of login related programs utilizes an alternate, non-readable file to contain the actual encrypted passwords. This is presumed to increase system security by increasing the difficulty with which system crackers obtain encrypted passwords. It was written by Julianne Frances Haugh and the Linux port is maintained by Tomasz Kloczko. This package provides 'login', which is needed to log into the system.")

tags=("base sys-auth")

build_deps="linux-pam acl libaudit"

source=("http://pkg-shadow.alioth.debian.org/releases/shadow-$pkgver.tar.bz2")
config_files="etc/login.defs
etc/pam.d/chage
etc/pam.d/chfn
etc/pam.d/chgpasswd
etc/pam.d/chpasswd
etc/pam.d/chsh
etc/pam.d/groupadd
etc/pam.d/groupdel
etc/pam.d/groupmems
etc/pam.d/groupmod
etc/pam.d/login
etc/pam.d/newusers
etc/pam.d/passwd
etc/pam.d/useradd
etc/pam.d/userdel
etc/pam.d/usermod
etc/default/useradd"

build() {
	go_src_dir
	burn_patches

	sed -i '/^user\(mod\|add\)_LDADD/s|$| -lattr|' src/Makefile.am
	#Ugh, force this to build shared libraries, for god's sake
	sed -i "s/noinst_LTLIBRARIES/lib_LTLIBRARIES/g" lib/Makefile.am
	libtoolize
	autoreconf

	# supress etc/pam.d/*, we provide our own
	sed -i '/^SUBDIRS/s/pam.d//' etc/Makefile.in

	export LDFLAGS="$SLKLDFLAGS -lcrypt"
	./configure --prefix=/usr --libdir=/lib${LIBDIRSUFFIX} \
		--mandir=/usr/man --sysconfdir=/etc \
		--disable-shared --enable-static \
		--with-libpam --without-selinux \
		--without-tcb \
		--without-group-name-max-length
	make -j${numjobs} || make
	make install DESTDIR=${pkgdir}

	# Remove system utils, it is provided by another packages
	
	# /bin/
	for file in login su; do
	  rm -v "$pkgdir/bin/"$file
	  find "$pkgdir/usr/man" -name "$file.1" -exec rm -v {} \;
	done
	
	
	# /usr/bin
	for file in chfn chsh newgrp; do
	  rm -v "$pkgdir/usr/bin/"$file
	  find "$pkgdir/usr/man" -name "$file.1" -exec rm -v {} \;
	done
	
	# /usr/sbin
	for file in vigr vipw; do
	  rm -v "$pkgdir/usr/sbin/"$file
	  find "$pkgdir/usr/man" -name "$file.8" -exec rm -v {} \;
	done

	set +e

	# 
	# Our custom adduser script
	install -D -m755 ${filedir}/adduser ${pkgdir}/usr/sbin/
	install -D -m644 ${filedir}/adduser_ru.mo ${pkgdir}/usr/share/locale/ru/LC_MESSAGES/adduser.mo
	install -D -m644 ${filedir}/adduser_uk.mo ${pkgdir}/usr/share/locale/uk/LC_MESSAGES/adduser.mo

	# Add pam.d configs
	for i in ${filedir}/pam/* ; do
		install -D -m0644 $i ${pkgdir}/etc/pam.d/`basename $i`
	done

	# Other stuff
	# useradd defaults
	install -Dm644 "${filedir}/useradd.defaults" "$pkgdir/etc/default/useradd"

	# cron job
	install -Dm744 "${filedir}/shadow.cron.daily" "$pkgdir/etc/cron.daily/shadow"

	# login.defs
	install -Dm644 "${filedir}/login.defs" "$pkgdir/etc/login.defs"

	# Remove static libs, since they are internal-only
	rm -f ${pkgdir}/{,usr}/lib${LIBDIRSUFFIX}/lib{misc,shadow}.{a,la}

	#rm -r ${pkgdir}/lib${LIBDIRSUFFIX}

}



