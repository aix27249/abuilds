# ABUILD generated by mkpkg_generator.sh

pkgname=ntp
pkgver=4.2.6p5
pkgbuild=4
arch=("auto")
config_files="etc/ntp.conf
etc/ntp-client.conf
etc/conf.d/ntp-client"

shortdesc=("ntp (Network Time Protocol daemon)")
longdesc=("The Network Time Protocol (NTP) is used to synchronize the time of a computer client or server to another server or reference time source, such as a radio or satellite receiver or modem. It provides client accuracies typically within a millisecond on LANs and up to a few tens of milliseconds on WANs relative to a primary server synchronized to Coordinated Universal Time (UTC) via a Global Positioning Service (GPS) receiver, for example.")

tags=("net-misc network")
source=("http://www.eecis.udel.edu/~ntp/ntp_spool/ntp4/ntp-4.2/ntp-${pkgver}.tar.gz")
build_deps="libcap libnl openssl readline libedit perl-html-parser tcp_wrappers"

build() {
	go_src_dir
	burn_patches

	set -e
	# avoid libmd5/libelf
	export ac_cv_search_MD5Init=no ac_cv_header_md5_h=no
	export ac_cv_lib_elf_nlist=no
	export LDFLAGS="${LDFLAGS//-Wl,--as-needed}"
	export CXXFLAGS="-D_GNU_SOURCE"
	ac_cv_header_dns_sd_h=0 ./configure LIBS=-lrt --prefix=/usr \
	  --libdir=/usr/lib${LIBDIRSUFFIX} \
	  --mandir=/usr/man \
	  --enable-linuxcaps \
	  --enable-ipv6 \
	  --with-crypto \
	  --with-libnl=libnl-3 \
	  --with-lineeditlibs=readline,edit,editline

	make -j${numjobs}
	  # install
	make DESTDIR="$pkgdir" install

	# install conf files
	mkdir -p "$pkgdir/usr/share/ntp"
	install -D -m644 conf/* "$pkgdir/usr/share/ntp/"

	# install man pages
	cd html
	../scripts/html2man
	sed -i 's/^[\t\ ]*$//;/./,/^$/!d' man/man*/*.[58]
	install -d "$pkgdir"/usr/man/man{5,8}
	install -m644 man/man5/* "$pkgdir/usr/man/man5/"
	install -m644 man/man8/* "$pkgdir/usr/man/man8/"
	mv "$pkgdir/usr/man/man8/ntpd.8" "$pkgdir/usr/man/man8/ntp-ntpd.8"
	cd ..

	# install server configs
	install -D -m644 ${filedir}/ntp.conf $pkgdir/etc/ntp.conf
	install -D -m644 ${filedir}/ntpd.conf.d ${pkgdir}/etc/conf.d/ntpd
	install -D -m755 ${filedir}/ntpd.init ${pkgdir}/etc/init.d/ntpd
	
	# install client configs
	install -D -m644 ${filedir}/ntp-client.conf ${pkgdir}/etc/ntp-client.conf
	install -D -m644 ${filedir}/ntp-client.conf.d ${pkgdir}/etc/conf.d/ntp-client
	install -D -m755 ${filedir}/ntp-client.init ${pkgdir}/etc/init.d/ntp-client	
	
	# create /var/lib/ntp
	mkdir -p "$pkgdir/var/lib/ntp"
	touch "$pkgdir/var/lib/ntp/.placeholder"
	
	set +e
}
