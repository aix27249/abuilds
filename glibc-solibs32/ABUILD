# ABUILD generated by mkpkg_generator.sh

pkgname=glibc-solibs
pkgver=2.12.2
pkgbuild=1
arch=("auto")

shortdesc=("glibc-solibs (GNU C libraries)")
longdesc=("This package contains the GNU C libraries and header files. The GNU C library was written originally by Roland McGrath, and is currently maintained by Ulrich Drepper. Some parts of the library were contributed or worked on by other people. Your system ha.")

tags=("base sys-base")

source=("http://ftp.gnu.org/gnu/glibc/glibc-${pkgver}.tar.xz")

pkglist="i18n"

config_files="etc/nscd.conf"

i18n() {
	pkgname=glibc-i18n
	shortdesc="GLIBC locales"
	longdesc="Locales for different languages. Metapackage that gathers all available glibc locales"
	tags=("libs sys-libs")
	pkg_files=package_i18n
}

before_build() {
	# glibc uses custom CFLAGS, specify them
	if [ "$ARCH" = "x86_64" ] ; then
		GLIBC_CFLAGS="-O3 -fPIC"
	else
		GLIBC_CFLAGS="-O3 -march=i686"
	fi
}

build() {
	go_src_dir
	burn_patches
	mkdir glibc_build
	cd glibc_build
	CGLAGS="${GLIBC_CFLAGS}"

	if [[ ${CARCH} = "i686" ]]; then
		# Hack to fix NPTL issues with Xen, only required on 32bit platforms
		export CFLAGS="${CFLAGS} -mno-tls-direct-seg-refs"
	fi

	export CFLAGS

	../configure \
	--prefix=/usr \
	--libdir=/usr/lib${LIBDIRSUFFIX} \
	--enable-kernel=2.6.18 \
	--with-headers=/usr/include \
	--enable-add-ons=libidn,nptl \
	--disable-profile \
	--infodir=/usr/info \
	--mandir=/usr/man \
	--enable-bind-now \
	--without-gd \
	--disable-multi-arch \
	--with-tls \
	--with-__thread \
	--without-cvs \
	$ARCH-slackware-linux

	make -j${numjobs} || make || exit 1
	make install install_root=${pkgdir} || exit 1
	mkdir -p ${startdir}/localepkg
	make localedata/install-locales install_root=${pkgdir} || exit 1

	# Now NOT provided by kernel-headers. Plz don't remove
	# rm ${pkgdir}/usr/include/scsi/scsi.h

	install -m644 $srcdir/glibc-${pkgver}/nscd/nscd.conf ${pkgdir}/etc/nscd.conf || exit 1
}

after_build() {
	mkdir -p ${startdir}/package_i18n/usr/lib${LIBDIRSUFFIX}
	mv -f ${pkgdir}/usr/lib${LIBDIRSUFFIX}/locale ${startdir}/package_i18n/usr/lib${LIBDIRSUFFIX}
	mv -f ${pkgdir}/usr/share/i18n ${startdir}/package_i18n/usr/share
	mv -f ${pkgdir}/usr/share/locale ${startdir}/package_i18n/usr/share
}


