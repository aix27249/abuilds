# ABUILD generated by mkpkg_generator.sh

pkgname=binutils
pkgver=2.21
pkgbuild=1
arch=("auto")

shortdesc=("binutils (GNU binary development tools)")
longdesc=("Binutils is a collection of binary utilities. It includes "as" (the portable GNU assembler), "ld" (the GNU linker), and other utilities for creating and working with binary programs. These utilities are REQUIRED to compile C, C++, Objective-C, Fortran, and most other programming languages.")

tags=("develop sys-devel")
source=("http://ftp.gnu.org/gnu/binutils/binutils-${pkgver}.tar.bz2")

build() {
	go_src_dir
	burn_patches
	set -e
	CFLAGS="$SLKCFLAGS" \
		./configure \
		--prefix=/usr \
		--libdir=/usr/lib${LIBDIRSUFFIX} \
		--mandir=/usr/man \
		--infodir=/usr/info \
		--with-docdir=/usr/doc/binutils-${pkgver} \
		--enable-shared \
		$( [ "$ARCH" = "x86_64" ] && echo --enable-64-bit-bfd ) \
		$( [ "$ARCH" = "x86_64" ] && echo --disable-multilib ) \
		--enable-targets=$ARCH-slackware-linux \
		$WERROR \
		--build=$ARCH-slackware-linux \
	|| exit 1

	make clean || exit 1
	make -j${numjobs} || make || exit 1
	make install DESTDIR=${pkgdir} || exit 1

	  # Rebuild libiberty.a with -fPIC
	make -C libiberty clean
	make CFLAGS="$SLKCFLAGS -fPIC" -C libiberty
	install -m644 libiberty/libiberty.a ${pkgdir}/usr/lib${LIBDIRSUFFIX}

	# Rebuild libbfd.a with -fPIC
	make -C bfd clean
	# hidden visability prevent 3rd party shared libraries exporting bfd non-stable API
	make CFLAGS="$SLKCFLAGS -fPIC -fvisibility=hidden" -C bfd
	install -m644 bfd/libbfd.a ${pkgdir}/usr/lib${LIBDIRSUFFIX}

	# "make install" skips this, but binutils.spec doesn't.  Sneaky, huh?
	cp -a include/libiberty.h ${pkgdir}/usr/include/libiberty.h
	
	# Differentiate between BSD strings and GNU strings
	( cd ${pkgdir}/usr/bin ; mv strings strings-GNU )
	( cd ${pkgdir}/usr/man/man1 ; mv strings.1 strings-GNU.1 )
	
	# Move ldscripts to /usr/lib${LIBDIRSUFFIX}, and then put symlinks in place
	mv ${pkgdir}/usr/${ARCH}-slackware-linux/lib/ldscripts ${pkgdir}/usr/lib${LIBDIRSUFFIX}
	( cd ${pkgdir}/usr/${ARCH}-slackware-linux
		ln -s /usr/lib${LIBDIRSUFFIX}/ldscripts lib/ldscripts
		for FILE in ar as ld nm objcopy objdump ranlib strip ; do
			if [ -r "/usr/bin/$FILE" ]; then
				rm -f bin/$FILE
				ln -s /usr/bin/$FILE bin/$FILE
			fi
		done
	)
      
	# Remove some unneeded man pages, and then compress the rest
	rm -f ${pkgdir}/usr/man/man1/{dlltool,windres}.1
	mkdir -p ${pkgdir}/usr/doc/binutils-${pkgver}
	set +e

}
