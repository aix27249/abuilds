# ABUILD generated by mkpkg_generator.sh

pkgname=lvm2
pkgver=2.02.98
pkgbuild=1
arch=("auto")

shortdesc=("Logical Volume Manager version 2")
longdesc=("Heinz Mauelshagen's LVM (Logical Volume Manager) for Linux. LVM adds an additional layer between the physical peripherals and the low-level I/O interface to get a logical view of disks. This allows the concatenation of several disks (so-called physical volumes or PVs) to form a storage pool (so-called Volume Group or VG) with allocation units called physical extents (called PE). With LVM, you can extend, resize, or relocate storage dynamically.")

build_deps="readline udev"
tags=("base sys-fs")
pkglist="dmap"
source=("ftp://sources.redhat.com/pub/lvm2/LVM2.${pkgver}.tgz")

config_files="etc/lvm/lvm.conf"
build() {
	go_src_dir
	burn_patches
	set -e
	sed -i 's|/usr/bin/tr|/bin/tr|' scripts/lvmdump.sh
	unset LDFLAGS
	./configure --prefix= \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--datarootdir=/usr/share \
		--includedir=/usr/include \
		--with-usrlibdir=/usr/lib${LIBDIRSUFFIX} \
		--libdir=/usr/lib${LIBDIRSUFFIX} \
		--with-udev-prefix="" \
		--enable-realtime \
		--enable-pkgconfig \
		--enable-readline \
		--enable-dmeventd \
		--enable-cmdlib \
		--with-lvm1=internal \
		--enable-applib \
		--with-udevdir=/lib/udev/rules.d/ \
		--enable-udev_sync \
		--enable-udev_rules \
		--with-device-uid=0 \
		--with-device-gid=6 \
		--with-device-mode=0600
		#--enable-static_link

	make -j${numjobs}
	make DESTDIR=${pkgdir} install_lvm2
	cd liblvm
	make DESTDIR=${pkgdir} install
	cd ..

	install -d ${pkgdir}/etc/lvm/{archive,backup}

	# And now - TEH K0STYLI: arch doesn't use this, but slackware does, and it seems that it is good idea:
	if [ -d ${pkgdir}/usr/share/man ]; then # --mandir was ignored
		mv ${pkgdir}/usr/share/man ${pkgdir}/usr
		rmdir ${pkgdir}/usr/share
	fi

	# Move the binary and shared library to /sbin and /lib{,64}:
	mkdir -p ${pkgdir}/lib${LIBDIRSUFFIX}
	( cd ${pkgdir}/usr/lib${LIBDIRSUFFIX}
		for file in lib*.so.?.* ; do
			mv $file ../../lib${LIBDIRSUFFIX}
			ln -sf ../../lib${LIBDIRSUFFIX}/$file .
		done
	)

	# The Makefile is DIW.
	( cd ${pkgdir}/usr/lib${LIBDIRSUFFIX}
		find . -name "*.so" -type l | cut -b3- | while read file ; do
			# These two excluded files are in ./device-mapper/ subdir
			if [ "$file" != "libdevmapper-event-lvm2mirror.so" -a "$file" != "libdevmapper-event-lvm2snapshot.so" ]; then
				rm -f $file
				ln -sf $(basename ../../lib${LIBDIRSUFFIX}/${file}.?.*) $file
			fi
		done
	)

	set +e
}

dmap() {
	pkgname="device-mapper"
	shortdesc="Device mapper userspace library and tools"
	longdesc="Device mapper userspace library and tools"
}

dmap_prep() {
	go_src_dir
	set -e
	make DESTDIR=${pkgdir} install_device-mapper

	# Another part of K0STYLI
	if [ -d ${pkgdir}/usr/share/man ]; then # --mandir was ignored
		mv ${pkgdir}/usr/share/man ${pkgdir}/usr
		rmdir ${pkgdir}/usr/share
	fi

	# Move the binary and shared library to /sbin and /lib{,64}:
	mkdir -p ${pkgdir}/lib${LIBDIRSUFFIX}
	( cd ${pkgdir}/usr/lib${LIBDIRSUFFIX}
		for file in lib*.so.?.* ; do
			mv $file ../../lib${LIBDIRSUFFIX}
			ln -sf ../../lib${LIBDIRSUFFIX}/$file .
		done
	)

	# The Makefile is DIW.
	( cd ${pkgdir}/usr/lib${LIBDIRSUFFIX}
		find . -name "*.so" -type l | cut -b3- | while read file ; do
			# These two excluded files are in ./device-mapper/ subdir
			if [ "$file" != "libdevmapper-event-lvm2mirror.so" -a "$file" != "libdevmapper-event-lvm2snapshot.so" ]; then
				rm -f $file
				ln -sf $(basename ../../lib${LIBDIRSUFFIX}/${file}.?.*) $file
			fi
		done
	)



	set +e
}


