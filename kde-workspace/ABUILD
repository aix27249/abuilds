# ABUILD generated by mkpkg_generator.sh

pkgname=kde-workspace
pkgver=4.10.4
#strict_version='yes'
pkgbuild=2
arch=('auto')

shortdesc=('KDE Base Workspace')

tags=('kde-base kde4')

source=("ftp://ftp.kde.org/pub/kde/stable/${pkgver}/src/${pkgname}-${pkgver}.tar.xz")

config_files="etc/kdm/kdmrc
etc/kdm/backgroundrc
etc/pam.d/kde
etc/pam.d/kde-np"

# Avoid a version number in .la files:
if [ -d /usr/lib${LIBDIRSUFFIX}/qt ]; then
  QTDIR=/usr/lib${LIBDIRSUFFIX}/qt
fi
adddep="kde-base-artwork"
BUILD_SYSTEM='cmake'
BUILD_KEYS="-DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_SKIP_RPATH=ON \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DMAN_INSTALL_DIR=/usr/man \
    -DWITH_Xmms=OFF \
    -DWITH_Nepomuk=ON \
    -DWITH_PolkitQt=OFF \
    -DWITH_QEdge=OFF \
    -DWITH_Googlegadgets=OFF \
    -DSYSCONF_INSTALL_DIR=/etc \
    -DLIB_SUFFIX=${LIBDIRSUFFIX}"
INSTALL_KEYS="DESTDIR=$pkgdir"

after_build() {
	set -e
	mkdir -p $pkgdir/etc/X11/xinit
	cat $filedir/xinit/xinitrc.kde > $pkgdir/etc/X11/xinit/xinitrc.kde
	chmod 0755 $pkgdir/etc/X11/xinit/xinitrc.kde

	# Setup config files for KDM:
	$pkgdir/usr/bin/genkdmconf --no-old --no-old-scripts --no-backup --in $pkgdir/usr/share/config/kdm

	# Not allowing root to login at the console is just plain silly.  If they 
	# have physical access to the machine, what's the point of trying to stop 
	# this?  Even the kdmrc file says this is supposed to be the default.
	sed -i 's/AllowRootLogin=false/AllowRootLogin=true/' \
		$pkgdir/usr/share/config/kdm/kdmrc 
	sed -i 's/#TerminateServer=true/TerminateServer=true/' \
		$pkgdir/usr/share/config/kdm/kdmrc

	cp -a $pkgdir/usr/share/config/kdm/Xsession $pkgdir/usr/share/config/kdm/Xsession.orig
	cat $filedir/config/Xsession | sed -e "s#/lib#/lib${LIBDIRSUFFIX}#" \
		> $pkgdir/usr/share/config/kdm/Xsession

	# Move the KDM files someplace FHS compliant:
	mkdir -p $pkgdir/etc
	mv $pkgdir/usr/share/config/kdm $pkgdir/etc
	( cd $pkgdir/usr/share/config ; ln -sf ../../../etc/kdm . )

	# This is fubar:
	rm -f $pkgdir/usr/share/icons/hicolor/index.theme

	# Init script for kdm
	mkdir -p ${pkgdir}/etc/init.d
	cat $filedir/init.d/kdm > ${pkgdir}/etc/init.d/kdm
	chmod 755 ${pkgdir}/etc/init.d/kdm

	mkdir -p ${pkgdir}/var/lib/kdm

	# PAM modules
	install -D -m0644 ${filedir}/kde.pam ${pkgdir}/etc/pam.d/kde
	install -D -m0644 ${filedir}/kde-np.pam ${pkgdir}/etc/pam.d/kde-np
	set +e
}

